@if (loading()) {
<div class="text-center py-20 text-text-muted">Loading assessment...</div>
} @else {
@if (!isStarted()) {
<div class="flex justify-center py-12 animate-fade-in">
    <div class="glass-pane max-w-[600px] p-12 text-center">
        <h2 class="text-4xl font-bold mb-6 text-white">{{ test().title }}</h2>
        <div class="flex gap-8 justify-center mb-10">
            <div class="flex items-center gap-2 text-text-muted">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                {{ test().duration }} Minutes
            </div>
            <div class="flex items-center gap-2 text-text-muted">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                {{ test().Questions.length }} Questions
            </div>
        </div>

        <div class="glass-pane p-6 text-left mb-10 bg-accent-warning/5 border-accent-warning/20">
            <div class="flex gap-2 text-accent-warning font-bold mb-4 items-center uppercase text-xs tracking-widest">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                    <line x1="12" y1="9" x2="12" y2="13" />
                    <line x1="12" y1="17" x2="12.01" y2="17" />
                </svg>
                Critical Security Policy
            </div>
            <ul class="text-sm text-text-muted space-y-3">
                <li>• <span class="text-white font-medium">Window switching</span> or tab blurring is strictly
                    prohibited and logged.</li>
                <li>• <span class="text-white font-medium">Auto-submission</span> will occur when the timer hits zero.
                </li>
                <li>• The session <span class="text-white font-medium">cannot be paused</span> once initiated.</li>
            </ul>
        </div>

        <button (click)="startTest()" class="btn btn-primary w-full py-4 text-center justify-center font-bold text-lg">
            Begin Assessment Now
        </button>
    </div>
</div>
} @else if (isFinished()) {
<div class="flex justify-center py-12 animate-fade-in">
    <div class="glass-pane max-w-[600px] w-full p-12 text-center overflow-hidden">
        <div
            class="bg-accent-success/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-8 text-accent-success">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
        </div>
        <h2 class="text-4xl font-bold mb-2 text-white">Test Completed</h2>
        <p class="text-text-muted mb-10">Verification engine has processed your results.</p>

        @if (result()) {
        <div class="glass-pane p-8 mb-10 bg-white/5 border-white/5">
            <div class="text-[10px] text-text-dim uppercase tracking-widest font-bold mb-2">Authenticated Final Score
            </div>
            <div class="text-6xl font-extrabold text-white">
                {{ result().score }}<span class="text-2xl text-text-dim font-normal"> / {{ result().maxScore }}</span>
            </div>
            <div class="mt-6 text-sm font-semibold"
                [ngClass]="result().score/result().maxScore >= 0.7 ? 'text-accent-success' : 'text-accent-warning'">
                {{ result().score/result().maxScore >= 0.7 ? 'Excellent! Access your certification in the dashboard.' :
                'Keep practicing to reach the 70% threshold.' }}
            </div>
        </div>
        }

        <div class="flex gap-4">
            <button (click)="download()" class="btn btn-primary flex-1 justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Download Certificate
            </button>
            <a routerLink="/dashboard" class="btn btn-secondary flex-1 justify-center">Return to Dashboard</a>
        </div>
    </div>
</div>
} @else {
<div class="max-w-[1100px] mx-auto py-8 animate-fade-in">
    <!-- Header -->
    <div class="flex justify-between items-center mb-10">
        <div>
            <h2 class="text-3xl font-bold text-white mb-1">{{ test().title }}</h2>
            <div class="text-accent-success text-[10px] font-bold uppercase tracking-widest flex items-center gap-2">
                <span class="w-1.5 h-1.5 bg-accent-success rounded-full animate-pulse"></span>
                Focus Mode Active • Status: SECURE
            </div>
        </div>
        <div class="bg-bg-surface px-8 py-4 rounded-md font-bold text-3xl flex items-center gap-4 border border-white/10"
            [ngClass]="timeLeft() < 60 ? 'text-accent-error bg-accent-error/5 border-accent-error/20' : 'text-text-main'">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
            </svg>
            {{ formatTime(timeLeft()) }}
        </div>
    </div>

    <!-- Progress -->
    <div class="h-1.5 bg-bg-surface rounded-full mb-12 overflow-hidden border border-white/5">
        <div class="h-full bg-primary transition-all duration-700 ease-in-out shadow-[0_0_15px_rgba(59,130,246,0.5)]"
            [style.width.%]="progress()"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8 items-start">
        <div class="glass-pane p-12 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-primary/30"></div>
            <div class="text-text-dim text-[10px] font-bold uppercase tracking-[0.2em] mb-4">Question {{
                currentQuestionIndex() + 1 }}</div>
            <h3 class="text-2xl font-medium leading-[1.6] mb-12 text-white">
                {{ test().Questions[currentQuestionIndex()].content }}
            </h3>

            <div class="space-y-4">
                @for (opt of test().Questions[currentQuestionIndex()].options; track $index) {
                <button (click)="selectOption(test().Questions[currentQuestionIndex()].id, $index)"
                    class="w-full text-left p-6 rounded-md border transition-all duration-300 flex items-center gap-6 group"
                    [ngClass]="answers()[test().Questions[currentQuestionIndex()].id] === $index ? 'bg-primary/10 border-primary text-white' : 'bg-white/[0.02] border-white/5 text-text-muted hover:border-white/20 hover:bg-white/[0.04]'">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold transition-colors"
                        [ngClass]="answers()[test().Questions[currentQuestionIndex()].id] === $index ? 'border-primary bg-primary text-white' : 'border-text-dim text-text-dim group-hover:border-text-muted'">
                        {{ ['A','B','C','D'][$index] }}
                    </div>
                    <span class="text-lg">{{ opt }}</span>
                </button>
                }
            </div>

            <div class="flex justify-between mt-16 pt-10 border-t border-white/5">
                <button class="btn btn-secondary px-8" (click)="prevQuestion()"
                    [disabled]="currentQuestionIndex() === 0">
                    Previous
                </button>

                @if (currentQuestionIndex() === test().Questions.length - 1) {
                <button (click)="submitTest()" class="btn btn-primary px-12 text-lg shadow-xl shadow-primary/20">Finish
                    Assessment</button>
                } @else {
                <button class="btn btn-primary px-10 text-lg" (click)="nextQuestion()">
                    Next Question
                </button>
                }
            </div>
        </div>

        <div class="glass-pane p-8 h-fit border-white/5">
            <h4 class="text-[10px] font-bold uppercase tracking-[0.2em] text-text-dim mb-8">Navigation Tree</h4>
            <div class="grid grid-cols-4 gap-3">
                @for (q of test().Questions; track q.id) {
                <button (click)="currentQuestionIndex.set($index)"
                    class="aspect-square rounded-sm text-xs font-bold border transition-all flex items-center justify-center"
                    [ngClass]="currentQuestionIndex() === $index ? 'bg-primary border-primary text-white shadow-lg shadow-primary/30 scale-110 z-10' : 
                          (answers()[q.id] !== undefined ? 'bg-accent-success/20 border-accent-success/30 text-accent-success' : 'bg-bg-surface border-transparent text-text-dim hover:border-white/20')">
                    {{ $index + 1 }}
                </button>
                }
            </div>
            <div class="mt-12 pt-8 border-t border-white/5 space-y-4">
                <div class="flex items-center gap-3 text-[10px] uppercase tracking-widest text-text-dim">
                    <div class="w-2.5 h-2.5 rounded-full bg-primary"></div> Active
                </div>
                <div class="flex items-center gap-3 text-[10px] uppercase tracking-widest text-text-dim">
                    <div class="w-2.5 h-2.5 rounded-full bg-accent-success/40 border border-accent-success/50"></div>
                    Answered
                </div>
                <div class="flex items-center gap-3 text-[10px] uppercase tracking-widest text-text-dim">
                    <div class="w-2.5 h-2.5 rounded-full bg-bg-surface border border-white/5"></div> Remaining
                </div>
            </div>
        </div>
    </div>
</div>
}
}